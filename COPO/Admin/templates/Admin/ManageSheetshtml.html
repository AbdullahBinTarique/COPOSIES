{% extends "Admin/COPOTemplate.html" %}
{% load static %}

{% block title %}
Manage Sheets
{% endblock %}
{% block content1 %}
<p class="text-body-secondary"> The Corelation sheet data is saved at the time of submission of
    data during the calculation of Course Outcome and Programme Outcome Mapping.</p>
{% endblock %}
{% block list %}
<li><a href="/Admin/Home/ViewCONAMES/" class="text-white">Consolidated COS Informations</a>
</li>
<li><a href="/Admin/Home/ViewCOPOAchieved/" class="text-white">Consolidated Direct
        Attainment</a></li>
<li><a href="/Admin/Home/ViewExternalCOPOAchieved/" class="text-white">All Threshold Based
        Scaled AVG</a></li>
<li><a href="/Admin/Home/ViewCourseExitCOPOAchieved/" class="text-white">CourseExit COPO
        Achieved</a></li>

<li><a href="/Admin/Home/ViewCourseExitThresholdBasedCOPOAchieved/" class="text-white">CourseExit Threshold Based
        Matrices</a></li>
<li> <a href='/'> <button>Main Page</button></a></li>
{% endblock %}

{% block content2 %}
<h1 class="fw-light">Manage Sheets</h1>
<p class="lead text-body-secondary">For Each of the Subjects , below are the Sheets representing the
    data</p>
<p>
<div class="  d-flex" style="justify-content: center;" id="docsearch"><button type="button" aria-label="Search (Ctrl+K)"
        class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><svg width="20" height="20"
                viewBox="0 0 20 20" aria-hidden="true" class="DocSearch-Search-Icon">
                <path
                    d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z"
                    stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg><input type="text" id="searchBoxBr" placeholder="Filter Branch..."
                onkeyup="searchPageBranch()"></span><span class="DocSearch-Button-Keys"> </span></button>

    <br>

    <button type="button" aria-label="Search (Ctrl+K)" class="DocSearch DocSearch-Button"><span
            class="DocSearch-Button-Container"><svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true"
                class="DocSearch-Search-Icon">
                <path
                    d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z"
                    stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg><input type="text" id="searchBoxBa" placeholder="Filter Batch..."
                onkeyup="searchPageBatch()"></span><span class="DocSearch-Button-Keys"></span></button>

    <br>

    <button type="button" aria-label="Search (Ctrl+K)" class="DocSearch DocSearch-Button"><span
            class="DocSearch-Button-Container"><svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true"
                class="DocSearch-Search-Icon">
                <path
                    d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z"
                    stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg><input type="text" id="searchBox" placeholder="Filter by Sem, Date/Time.."
                onkeyup="searchPageSem()"></span><span class="DocSearch-Button-Keys"></span></button>

    <button type="button" aria-label="Search (Ctrl+K)" class="DocSearch DocSearch-Button" id="Filter">Filter</button>
</div>
</p>
{% endblock %}

{% block content3 %}
{% for x in INS %}
<div class="col-lg-6">

    <div class="card shadow-sm forbuttons" data-brn="{{x.branch}}" data-sem="{{subj.sem}}" data-batch="{{x.batch}}">
        <div style="width:100%; height:230px ; " class="Expandable">
            <svg class="bd-placeholder-img card-img-top" style="position:absolute ; " width="90%" height="225px"
                xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail"
                preserveAspectRatio="xMidYMid slice" focusable="false">
                <title>Placeholder</title>
                <image style="filter: blur(4px);opacity: 0.5;;" x="0" y="0" width="100%" height="100%"
                    href="{% static 'Pics/' %}{% cycle 'Physics.jpg' 'Maths.jpg' 'Java.jpg' 'PCE.jpg' 'CP.jpg' 'AOA.jpg' 'AI.jpg' 'CG.jpg' 'dlcoa.jpg' 'DS.jpg' 'DSGT.jpg' 'EG.jpg' 'MP.jpg' 'NLPP.jpg' 'RDBMS.jpg' 'Java.jpg' %}"
                    alt="Example Img" preserveAspectRatio="xMidYMid slice" />

            </svg>
            <svg style="position:absolute; " class="bd-placeholder-img card-img-top" width="100%" height="225px"
                aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false">
                <title>{{x.uploaded_by}}</title>
                <text x="50%" y="50%" fill="#eceeef" dy=".3em">{{x.uploaded_by}}</text>
            </svg>
        </div>



        <div class="card-body">
            <p class="card-text">
            <h3 id='subjh3' class="searchable id">{{x.subject}}-{{x.uploaded_by}}</h3>

            <h6 class="searchableBa" data-batch="{{x.batch}}">Batch :{{x.batch}}</h6>
            <h6 class="searchableBr" data-branch="{{x.branch}}">Branch :{{x.branch}} </h6>

            <h6 data-times="{{ x.uploade_date}}" class="timed"></h6>
            </p>
            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-secondary   enlarge-btn"
                        id="open-new-tab">View</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary   del"
                        id="{{x.subject}}-delete">Delete</button>
                </div>

                <small class="text-body-secondary" class="searchable ">Uploaded at {{ x.uploade_date}}</small>

                <small class="text-body-secondary" class="searchable ">
                    {{x.uploade_date|timesince }} ago</small>

            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
{% block script %}
<script>
    function searchPageBranch() {
        const input = document.getElementById('searchBoxBr').value.toLowerCase();
        const elements = document.querySelectorAll('.searchableBr');


        elements.forEach(element => {
            if (element.textContent.toLowerCase().includes(input)) {
                element.closest('.card').style.display = 'block'; // Show matching elements
            } else {
                element.closest('.card').style.display = 'none'; // Hide non-matching elements
            }
        });
    }
    function searchPageBatch() {
        const input = document.getElementById('searchBoxBa').value.toLowerCase();
        const elements = document.querySelectorAll('.searchableBa');


        elements.forEach(element => {
            if (element.textContent.toLowerCase().includes(input)) {
                element.closest('.card').style.display = 'block'; // Show matching elements
            } else {
                element.closest('.card').style.display = 'none'; // Hide non-matching elements
            }
        });
    }
    function searchPageSem() {
        const input = document.getElementById('searchBox').value.toLowerCase();
        const elements = document.querySelectorAll('.searchable');


        elements.forEach(element => {
            if (element.textContent.toLowerCase().includes(input)) {
                element.closest('.card').style.display = 'block'; // Show matching elements
            } else {
                element.closest('.card').style.display = 'none'; // Hide non-matching elements
            }
        });
    }

    const buttons = document.querySelectorAll('.enlarge-btn');


    document.addEventListener('click', function (event) {
        if (event.target.id === 'Filter') {


            const br = document.getElementById("searchBoxBr");
            const ba = document.getElementById("searchBoxBa");
            const va = document.getElementById("searchBox");
            const cards = document.querySelectorAll(".card");
            function applyFilters() {
                const brval = br.value
                const baval = ba.value
                const vaval = va.value
                cards.forEach(card => {
                    const cardbr = card.dataset.brn
                    const cardba = card.dataset.batch
                    const cardva = card.dataset.sem

                    const matchesbr = cardbr === brval
                    const matchesba = cardba === baval
                    const matchesva = cardva === vaval

                    if (matchesbr && matchesba && matchesva) {
                        card.style.display = "block"
                    }
                    else {
                        card.style.display = "none"
                    }

                })
            }
            applyFilters()

        }
    })

    document.addEventListener('DOMContentLoaded', () => {
        const but = document.querySelectorAll('.del')
        but.forEach((button) => {
            button.addEventListener('click', (event) => {
                const card = event.target.closest('.card')
                let subname = card.querySelector('.id').textContent
                subname = subname.trim().split('-')
                let time = card.querySelector('.timed')
                time = time.dataset.times


                if (confirm("Are you sure you want to delete the Sheet, All the data related to this sheet will be lost")) {
                    $.ajax({
                        url: '/Admin/Home/delete',
                        type: 'POST',
                        data: {
                            // Send JSON string as data


                            time: time,

                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        }, success: function (data) {
                            if (data.message) {
                                alert(data.message);
                                location.reload(true);
                            }
                        }
                    })
                }
            })
        })
    })



    // Add event listener to each button
    buttons.forEach((button) => {
        button.addEventListener('click', (event) => {
            const card = event.target.closest('.card');
            let time = card.querySelector('.timed')
            time = time.dataset.times

            $.ajax({
                url: '/Admin/Home/ViewSheet',
                type: 'POST',
                data: {
                    // Send JSON string as data
                    times: time,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, success: function (data) {
                    const newTab = window.open();

                    newTab.document.body.innerHTML = JSON.parse(data.html);

                }
            })

        });
    });


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}